<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊòìÁªèÂç†Âçú - I Ching Divination</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8B0000;
            --primary-light: #B22222;
            --gold: #D4AF37;
            --gold-light: #F4E4BA;
            --bg-dark: #1a1a1a;
            --bg-paper: #F5F0E6;
            --text: #2C1810;
            --text-light: #5D4037;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background: var(--bg-dark);
            min-height: 100vh;
            color: var(--text);
        }

        /* Â∞ÅÈù¢ËÉåÊôØ */
        .cover {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.8) 100%),
                linear-gradient(135deg, #1a1a1a 0%, #2d1f1f 50%, #1a1a1a 100%);
            z-index: -1;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Ê†áÈ¢ò */
        .header {
            text-align: center;
            padding: 40px 0;
            color: var(--gold);
        }

        .title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            letter-spacing: 4px;
        }

        /* Âç†ÂçúÂç°Áâá */
        .divination-card {
            background: var(--bg-paper);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                inset 0 0 100px rgba(139,0,0,0.03);
            position: relative;
            overflow: hidden;
        }

        .divination-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--gold), var(--primary), var(--gold));
        }

        /* ËæìÂÖ•Âå∫Âüü */
        .question-section {
            margin-bottom: 30px;
        }

        .question-label {
            display: block;
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .question-input {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-family: inherit;
            border: 2px solid #D4C4B0;
            border-radius: 8px;
            background: rgba(255,255,255,0.8);
            transition: all 0.3s;
        }

        .question-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(212,175,55,0.2);
        }

        /* Âç†ÂçúÊåâÈíÆ */
        .divine-btn {
            width: 100%;
            padding: 20px 40px;
            font-size: 1.3rem;
            font-family: 'Ma Shan Zheng', cursive;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--gold-light);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .divine-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .divine-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139,0,0,0.4);
        }

        .divine-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .divine-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ÈìúÈí±Âä®Áîª */
        .coins-animating {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .coins-animating.show {
            opacity: 1;
        }

        .coin {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold) 0%, #8B7355 50%, var(--gold) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.3),
                inset 0 2px 5px rgba(255,255,255,0.3);
            animation: none;
        }

        .coin.flipping {
            animation: flip 0.5s ease-in-out infinite;
        }

        @keyframes flip {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        /* ÁªìÊûúÂå∫Âüü */
        .result {
            display: none;
            margin-top: 40px;
            animation: fadeIn 0.8s ease;
        }

        .result.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Âç¶Ë±°Â±ïÁ§∫ */
        .hexagram-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .hexagram-symbol {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 6rem;
            color: var(--primary);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            line-height: 1.2;
        }

        .hexagram-name {
            font-size: 2rem;
            color: var(--text);
            margin: 10px 0;
        }

        .hexagram-english {
            font-size: 1.1rem;
            color: var(--text-light);
            font-style: italic;
        }

        /* Âç¶Ë±°Á¨¶Âè∑Á∫ø */
        .hexagram-lines {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 8px;
            margin: 20px 0;
        }

        .yao {
            width: 120px;
            height: 12px;
            border-radius: 6px;
            background: var(--text);
            position: relative;
        }

        .yao.broken {
            background: transparent;
        }

        .yao.broken::before,
        .yao.broken::after {
            content: '';
            position: absolute;
            top: 0;
            width: 45%;
            height: 100%;
            background: var(--text);
            border-radius: 6px;
        }

        .yao.broken::before { left: 0; }
        .yao.broken::after { right: 0; }

        .yao.changing {
            background: var(--primary);
            animation: pulse 1s ease-in-out infinite;
        }

        .yao.changing.broken::before,
        .yao.changing.broken::after {
            background: var(--primary);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Âç¶Ëæû */
        .hexagram-content {
            text-align: left;
            padding: 20px;
            background: rgba(212,175,55,0.1);
            border-radius: 8px;
            border-left: 4px solid var(--gold);
        }

        .content-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-text {
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text);
            margin-bottom: 15px;
        }

        .content-meaning {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text-light);
        }

        /* ÂèòÁàªËØ¥Êòé */
        .changing-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(139,0,0,0.08);
            border-radius: 8px;
        }

        .changing-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .changing-lines {
            font-size: 0.9rem;
            line-height: 1.8;
            color: var(--text-light);
        }

        /* ÂéÜÂè≤ËÆ∞ÂΩï */
        .history-section {
            margin-top: 30px;
        }

        .history-title {
            font-size: 1.2rem;
            color: var(--gold);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .history-item:hover {
            border-color: var(--gold);
            background: rgba(255,255,255,0.1);
        }

        .history-item .date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .history-item .question {
            font-size: 0.95rem;
            color: var(--gold-light);
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item .result-text {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* È°µËÑö */
        .footer {
            text-align: center;
            padding: 30px;
            color: rgba(255,255,255,0.4);
            font-size: 0.85rem;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 600px) {
            .title { font-size: 2.5rem; }
            .divination-card { padding: 25px; }
            .coin { width: 60px; height: 60px; font-size: 1.5rem; }
            .hexagram-symbol { font-size: 4rem; }
            .hexagram-name { font-size: 1.5rem; }
            .yao { width: 100px; }
        }
    </style>
</head>
<body>
    <div class="cover"></div>
    
    <div class="container">
        <header class="header">
            <h1 class="title">ÊòìÁªèÂç†Âçú</h1>
            <p class="subtitle">I CHING DIVINATION</p>
        </header>

        <main class="divination-card">
            <section class="question-section">
                <label class="question-label">ËØ∑Âú®ÂøÉ‰∏≠ÈªòÂøµÊÇ®ÁöÑÈóÆÈ¢òÔºö</label>
                <input type="text" class="question-input" id="question" placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑ‰∫ã‰∏öÂèëÂ±ïÂ¶Ç‰ΩïÔºü" maxlength="100">
            </section>

            <button class="divine-btn" id="divineBtn" onclick="startDivination()">
                ÂºÄÂßãÂç†Âçú
            </button>

            <div class="coins-animating" id="coinsAnimating">
                <div class="coin" id="coin1">?</div>
                <div class="coin" id="coin2">?</div>
                <div class="coin" id="coin3">?</div>
            </div>

            <section class="result" id="result">
                <div class="hexagram-display">
                    <div class="hexagram-symbol" id="hexagramSymbol"></div>
                    <div class="hexagram-name" id="hexagramName"></div>
                    <div class="hexagram-english" id="hexagramEnglish"></div>
                    <div class="hexagram-lines" id="hexagramLines"></div>
                </div>

                <div class="hexagram-content">
                    <div class="content-title">
                        <span>‰∑ä</span> Âç¶Ëæû
                    </div>
                    <div class="content-text" id="judgment"></div>
                    <div class="content-meaning" id="judgmentMeaning"></div>
                </div>

                <div class="hexagram-content" style="margin-top: 20px;">
                    <div class="content-title">
                        <span>‰∑∂</span> Ëß£Èáä
                    </div>
                    <div class="content-meaning" id="meaning"></div>
                </div>

                <div class="changing-info" id="changingInfo" style="display: none;">
                    <div class="changing-title">‚ö° ÂèòÁàªÊèêÁ§∫</div>
                    <div class="changing-lines" id="changingLines"></div>
                </div>
            </section>

            <section class="history-section" id="historySection">
                <h3 class="history-title">üìú ÂéÜÂè≤ËÆ∞ÂΩï</h3>
                <div class="history-list" id="historyList"></div>
            </section>
        </main>

        <footer class="footer">
            <p>ÂøÉËØöÂàôÁÅµ | ‰ªÖ‰æõÂèÇËÄÉ</p>
        </footer>
    </div>

    <script>
        let isDivining = false;

        // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('iching_history') || '[]');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="color: rgba(255,255,255,0.4); text-align: center;">ÊöÇÊó†ËÆ∞ÂΩï</p>';
                return;
            }

            historyList.innerHTML = history.slice(0, 10).map((item, index) => `
                <div class="history-item" onclick="showHistory(${index})">
                    <div class="date">${item.date}</div>
                    <div class="question">${item.question || 'Êú™ÁΩ≤ÂêçÈóÆÈ¢ò'}</div>
                    <div class="result-text">${item.name} - ${item.english}</div>
                </div>
            `).join('');
        }

        // ÊòæÁ§∫ÂéÜÂè≤ËÆ∞ÂΩïËØ¶ÊÉÖ
        function showHistory(index) {
            const history = JSON.parse(localStorage.getItem('iching_history') || '[]');
            const item = history[index];
            if (!item) return;

            document.getElementById('hexagramSymbol').textContent = item.gua;
            document.getElementById('hexagramName').textContent = item.name;
            document.getElementById('hexagramEnglish').textContent = item.english;
            document.getElementById('judgment').textContent = item.judgment;
            document.getElementById('judgmentMeaning').textContent = item.judgmentMeaning;
            document.getElementById('meaning').textContent = item.meaning;

            // ÊòæÁ§∫Âç¶Ë±°Á∫ø
            const linesContainer = document.getElementById('hexagramLines');
            linesContainer.innerHTML = item.guaValues.map((value, idx) => {
                const isYin = value < 8;
                const isChanging = item.changing.includes(idx + 1);
                return `<div class="yao ${isYin ? 'broken' : ''} ${isChanging ? 'changing' : ''}"></div>`;
            }).join('');

            // ÊòæÁ§∫ÂèòÁàª‰ø°ÊÅØ
            if (item.changing.length > 0) {
                document.getElementById('changingInfo').style.display = 'block';
                document.getElementById('changingLines').textContent = 
                    `Á¨¨ ${item.changing.join('„ÄÅ')} Áàª‰∏∫ÂèòÁàªÔºåÂ∞ÜÂèëÁîüÂèòÂåñ„ÄÇËØ∑ÁïôÊÑèÂèòÂåñÂêéÁöÑÊú∫ÈÅá‰∏éÊåëÊàò„ÄÇ`;
            } else {
                document.getElementById('changingInfo').style.display = 'none';
            }

            document.getElementById('result').classList.add('show');
        }

        // ÂºÄÂßãÂç†Âçú
        async function startDivination() {
            if (isDivining) return;
            
            const question = document.getElementById('question').value.trim();
            const btn = document.getElementById('divineBtn');
            const coinsAnim = document.getElementById('coinsAnimating');
            const result = document.getElementById('result');
            
            isDivining = true;
            btn.disabled = true;
            btn.textContent = 'Âç†Âçú‰∏≠...';
            result.classList.remove('show');
            coinsAnim.classList.add('show');

            // ÈìúÈí±Âä®Áîª
            ['coin1', 'coin2', 'coin3'].forEach(id => {
                document.getElementById(id).classList.add('flipping');
            });

            // Á≠âÂæÖÂä®Áîª
            await new Promise(resolve => setTimeout(resolve, 2000));

            // ÂÅúÊ≠¢Âä®Áîª
            ['coin1', 'coin2', 'coin3'].forEach(id => {
                document.getElementById(id).classList.remove('flipping');
            });

            try {
                // Ë∞ÉÁî®API
                const response = await fetch('/api/divination', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Ëé∑ÂèñÂç¶Ë±°ËØ¶ÊÉÖ
                    const hexResponse = await fetch(`/api/hexagram/${data.mainNumber}`);
                    const hexData = await hexResponse.json();

                    if (hexData.success) {
                        displayResult(data, hexData, question);
                        saveHistory(data, hexData, question);
                    }
                }
            } catch (error) {
                console.error('Âç†ÂçúÂ§±Ë¥•:', error);
                alert('Âç†ÂçúËøáÁ®ãÂá∫ÈîôÔºåËØ∑ÈáçËØï');
            }

            isDivining = false;
            btn.disabled = false;
            btn.textContent = 'ÂÜçÊ¨°Âç†Âçú';
            coinsAnim.classList.remove('show');
        }

        // ÊòæÁ§∫ÁªìÊûú
        function displayResult(data, hexData, question) {
            document.getElementById('hexagramSymbol').textContent = hexData.gua;
            document.getElementById('hexagramName').textContent = hexData.name;
            document.getElementById('hexagramEnglish').textContent = `${hexData.latin} - ${hexData.english}`;
            document.getElementById('judgment').textContent = hexData.judgment;
            document.getElementById('judgmentMeaning').textContent = hexData.judgmentMeaning;
            document.getElementById('meaning').textContent = hexData.meaning;

            // ÊòæÁ§∫Âç¶Ë±°Á∫ø
            const linesContainer = document.getElementById('hexagramLines');
            linesContainer.innerHTML = data.gua.map((value, idx) => {
                const isYin = value < 8;
                const isChanging = data.changing.includes(idx + 1);
                return `<div class="yao ${isYin ? 'broken' : ''} ${isChanging ? 'changing' : ''}" title="${getYaoName(idx + 1, value)}"></div>`;
            }).join('');

            // ÊòæÁ§∫ÂèòÁàª‰ø°ÊÅØ
            if (data.changing.length > 0) {
                document.getElementById('changingInfo').style.display = 'block';
                document.getElementById('changingLines').textContent = 
                    `Á¨¨ ${data.changing.join('„ÄÅ')} Áàª‰∏∫ÂèòÁàªÔºà${data.changing.map(n => getYaoName(n, data.gua[n-1])).join('„ÄÅ')}ÔºâÔºåÂ∞ÜÂèëÁîüÂèòÂåñ„ÄÇËØ∑ÁïôÊÑèÂèòÂåñÂêéÁöÑÊú∫ÈÅá‰∏éÊåëÊàò„ÄÇ`;
            } else {
                document.getElementById('changingInfo').style.display = 'none';
            }

            document.getElementById('result').classList.add('show');
            
            // ÊªöÂä®Âà∞ÁªìÊûú
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

        // Ëé∑ÂèñÁàªÂêç
        function getYaoName(position, value) {
            const names = ['Âàù', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', '‰∏ä'];
            const type = value === 6 || value === 9 ? 'ËÄÅÈò¥/ËÄÅÈò≥' : (value === 7 ? 'Â∞ëÈò≥' : 'Â∞ëÈò¥');
            return names[position - 1] + 'Áàª(' + type + ')';
        }

        // ‰øùÂ≠òÂéÜÂè≤
        function saveHistory(data, hexData, question) {
            const history = JSON.parse(localStorage.getItem('iching_history') || '[]');
            history.unshift({
                date: new Date().toLocaleString('zh-CN'),
                question,
                name: hexData.name,
                english: hexData.english,
                gua: hexData.gua,
                judgment: hexData.judgment,
                judgmentMeaning: hexData.judgmentMeaning,
                meaning: hexData.meaning,
                guaValues: data.gua,
                changing: data.changing,
                mainNumber: data.mainNumber
            });
            
            // Âè™‰øùÂ≠òÊúÄËøë20Êù°
            if (history.length > 20) history.pop();
            localStorage.setItem('iching_history', JSON.stringify(history));
            
            loadHistory();
        }

        // È°µÈù¢Âä†ËΩΩ
        loadHistory();
    </script>
</body>
</html>
